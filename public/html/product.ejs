<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <link rel="stylesheet" href="/css/products.css" />
    <link rel="stylesheet" href="/css/main.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <%- include('layouts/navbar', {categories:categories}); -%>
    <div id="temporaryContent">
      <div class="detail">
        <div>
          <div class="image">
            <img
              src="<%= product.image[1]%>"
              alt="<%=product.alt_text%>"
              id="mainImage"
            />
          </div>
          <div class="imageCarousel">
            <% product.image.map((i,j) => { %>
            <img src="<%= i %>" />
            <% }) %>
          </div>
        </div>
        <div class="content">
          <div class="name"><%=product.name%></div>
          <div class="sku"><%=product.sku%></div>
          <div class="price"><%=product.price%></div>
          <div class="buttons">
            <button id="productCheckout">Checkout</button>
            <button
              class="addCart"
              data-id="<%= product.id %>,<%= product.name %>,<%= product.price %>,<%= product.image[1] %>"
            >
              Add to Cart
            </button>
          </div>
          <div class="description"><%=product.description%></div>
        </div>
        <div class="title">Similar Products</div>
      </div>
      <div
        class="similarProduct"
        data-prod="<%= product.id %>, <%= product.category %>"
      ></div>
    </div>
    <%- include('layouts/message'); %> <%- include('layouts/footer'); -%>
  </body>
  <script type="module">
    import { setItemCart } from "/js/cart.js";
    import { getSimilar, postSingleCheckout } from "/js/helpers.js";

    const button = document.querySelector(".addCart");
    const carousel = document.querySelector(".imageCarousel");
    const image = document.getElementById("mainImage");
    const similarProduct = document.querySelector(".similarProduct");
    const prodCheckout = document.getElementById("productCheckout");

    const [id, category] = similarProduct.dataset.prod.split(",");

    const data = await getSimilar(id, category.trim());

    data.map((e, i) => {
      similarProduct.innerHTML += `
    <div class="item">
      <a href="/product/${e.id}">
        <img src="${e.image[1]}" alt="${e.image[0]}" />
      </a>
      <div>
        <p>${e.name.toLowerCase()}</p>
        <div class="price">${e.price}</div>
        <button
          class="addCart"
          data-id="${e.id},${e.name},${e.price},${e.image[1]}"
        >
          Add To Cart
        </button>
      </div>
    </div>`;
    });

    for (var c of carousel.children) {
      c.addEventListener("click", (e) => {
        image.src = e.target.src;
      });
    }

    document.querySelectorAll(".addCart").forEach((button) => {
      button.addEventListener("click", (e) => {
        const [id, name, price, image] = e.target.dataset.id.split(",");
        setItemCart(id, name, price, image, 1);
      });
    });

    prodCheckout.addEventListener("click", async () => {
      await postSingleCheckout(id);
    });
  </script>
</html>
